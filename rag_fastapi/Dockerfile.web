# Dockerfile.web
# This Dockerfile builds the image for the web service using a multi-stage build.

# --- Stage 1: Base Image Build (from Dockerfile.base) ---
FROM python:3.11-slim-bookworm AS builder

# Install system dependencies
RUN apt-get update && \
    apt-get -y install netcat-openbsd tini curl && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy requirements.txt to leverage Docker cache
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Entrypoint for tini for proper signal handling (will be overridden by final stage CMD)
# ENTRYPOINT ["/usr/bin/tini", "--"]


# --- Stage 2: Final Web Service Image ---
FROM builder AS final-web-image

# Copy application code and relevant assets from the context
COPY app /app/app

# Copy wait-for-redis.sh script and make it executable
COPY scripts/wait-for-redis.sh /wait/wait-for-redis.sh
RUN chmod +x /wait/wait-for-redis.sh

# Command to run the web service (this will be overridden by docker-compose.yml)
# CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
